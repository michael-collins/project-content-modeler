<!DOCTYPE html>
<html>
<head>
  <title>Content Model Builder</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }
    .main-content {
      flex: 1;
    }
    .github-panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    .section { 
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      background: white;
    }
    .nested { margin-left: 20px; }
    button {
      background: #0366d6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
      width: 100%;
    }
    button:hover { opacity: 0.9; }
    button:disabled { 
      background: #ccc;
      cursor: not-allowed;
    }
    .remove-btn {
      background: #dc3545;
      width: auto;
      float: right;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      display: block;
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
    }
    .auth-section {
      margin-bottom: 20px;
    }
    .user-info {
      display: none;
      margin-bottom: 15px;
    }
    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
    }
    #login-button {
      background: #24292e;
    }
    #save-button {
      background: #28a745;
    }
    #load-button {
      background: #0366d6;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="header">
        <h1>Content Model Builder</h1>
      </div>
      <div id="pathways"></div>
      <button onclick="addPathway()">Add Pathway</button>
    </div>

    <div class="github-panel">
      <div class="auth-section">
        <div id="login-section">
          <button id="login-button" onclick="handleGitHubLogin()">
            Login with GitHub
          </button>
        </div>
        <div id="user-info" class="user-info">
          <img id="user-avatar" src="" alt="User avatar">
          <span id="user-name"></span>
          <button onclick="handleLogout()" style="margin-top: 10px">Logout</button>
        </div>
      </div>

      <div id="github-controls" style="display: none;">
        <select id="repo-select" onchange="handleRepoChange()">
          <option value="">Select Repository</option>
        </select>
        
        <select id="branch-select">
          <option value="">Select Branch</option>
        </select>
        
        <input type="text" 
               id="file-path" 
               placeholder="File path (e.g., content/model.json)"
               value="content-model.json">
        
        <button id="save-button" onclick="saveToGitHub()">
          Save to GitHub
        </button>
        <button id="load-button" onclick="loadFromGitHub()">
          Load from GitHub
        </button>
      </div>
      
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    // Content model state
    let contentModel = { pathways: [] };
    
    // GitHub configuration
    const CLIENT_ID = 'YOUR_GITHUB_CLIENT_ID';
    const REDIRECT_URI = window.location.href.split('?')[0];
    let githubToken = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check for OAuth callback
      const code = new URLSearchParams(window.location.search).get('code');
      if (code) {
        handleOAuthCallback(code);
      }
      
      // Check for stored token
      const storedToken = localStorage.getItem('github_token');
      if (storedToken) {
        githubToken = storedToken;
        showGitHubControls();
        loadUserInfo();
        loadUserRepos();
      }
    });

    // GitHub OAuth flow
    function handleGitHubLogin() {
      const scope = 'repo';
      window.location.href = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=${scope}`;
    }

    async function handleOAuthCallback(code) {
      // Use a proxy server to exchange the code for a token
      // You'll need to set up a simple proxy server to handle the OAuth exchange
      try {
        const response = await fetch('YOUR_PROXY_SERVER/github/oauth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        
        const data = await response.json();
        if (data.access_token) {
          githubToken = data.access_token;
          localStorage.setItem('github_token', githubToken);
          showGitHubControls();
          loadUserInfo();
          loadUserRepos();
          // Remove code from URL
          window.history.replaceState({}, document.title, REDIRECT_URI);
        }
      } catch (error) {
        showStatus('Authentication failed', 'error');
      }
    }

    function handleLogout() {
      localStorage.removeItem('github_token');
      githubToken = null;
      document.getElementById('github-controls').style.display = 'none';
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('repo-select').innerHTML = '<option value="">Select Repository</option>';
      document.getElementById('branch-select').innerHTML = '<option value="">Select Branch</option>';
    }

    // GitHub API interactions
    async function loadUserInfo() {
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        const user = await response.json();
        
        document.getElementById('user-avatar').src = user.avatar_url;
        document.getElementById('user-name').textContent = user.login;
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('login-section').style.display = 'none';
      } catch (error) {
        showStatus('Failed to load user info', 'error');
      }
    }

    async function loadUserRepos() {
      try {
        const response = await fetch('https://api.github.com/user/repos', {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        const repos = await response.json();
        
        const select = document.getElementById('repo-select');
        select.innerHTML = '<option value="">Select Repository</option>';
        repos.forEach(repo => {
          const option = document.createElement('option');
          option.value = repo.full_name;
          option.textContent = repo.full_name;
          select.appendChild(option);
        });
      } catch (error) {
        showStatus('Failed to load repositories', 'error');
      }
    }

    async function handleRepoChange() {
      const repo = document.getElementById('repo-select').value;
      if (!repo) return;

      try {
        const response = await fetch(`https://api.github.com/repos/${repo}/branches`, {
          headers: { 'Authorization': `token ${githubToken}` }
        });
        const branches = await response.json();
        
        const select = document.getElementById('branch-select');
        select.innerHTML = '<option value="">Select Branch</option>';
        branches.forEach(branch => {
          const option = document.createElement('option');
          option.value = branch.name;
          option.textContent = branch.name;
          select.appendChild(option);
        });
      } catch (error) {
        showStatus('Failed to load branches', 'error');
      }
    }

    async function saveToGitHub() {
      const repo = document.getElementById('repo-select').value;
      const branch = document.getElementById('branch-select').value;
      const filePath = document.getElementById('file-path').value;
      
      if (!repo || !branch || !filePath) {
        showStatus('Please select repository, branch, and file path', 'error');
        return;
      }

      try {
        // Get current file SHA if it exists
        let sha = '';
        try {
          const fileResponse = await fetch(
            `https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`,
            {
              headers: { 'Authorization': `token ${githubToken}` }
            }
          );
          const fileData = await fileResponse.json();
          sha = fileData.sha;
        } catch (error) {
          // File doesn't exist yet, which is fine
        }

        // Save the file
        const content = btoa(JSON.stringify(contentModel, null, 2));
        const response = await fetch(
          `https://api.github.com/repos/${repo}/contents/${filePath}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${githubToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: 'Update content model',
              content: content,
              branch: branch,
              sha: sha || undefined
            })
          }
        );

        if (!response.ok) throw new Error('Failed to save file');
        showStatus('Successfully saved to GitHub!', 'success');
      } catch (error) {
        showStatus('Failed to save to GitHub: ' + error.message, 'error');
      }
    }

    async function loadFromGitHub() {
      const repo = document.getElementById('repo-select').value;
      const branch = document.getElementById('branch-select').value;
      const filePath = document.getElementById('file-path').value;
      
      if (!repo || !branch || !filePath) {
        showStatus('Please select repository, branch, and file path', 'error');
        return;
      }

      try {
        const response = await fetch(
          `https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`,
          {
            headers: { 'Authorization': `token ${githubToken}` }
          }
        );
        
        if (!response.ok) throw new Error('Failed to load file');
        
        const data = await response.json();
        contentModel = JSON.parse(atob(data.content));
        renderContent();
        showStatus('Successfully loaded from GitHub!', 'success');
      } catch (error) {
        showStatus('Failed to load from GitHub: ' + error.message, 'error');
      }
    }

    // UI Helpers
    function showGitHubControls() {
      document.getElementById('github-controls').style.display = 'block';
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      setTimeout(() => {
        status.className = 'status';
      }, 5000);
    }

    // Content Builder Functions
    // (Include all your existing content builder functions here)
    // This includes addPathway(), renderContent(), etc.
    
  </script>
</body>
</html>
